<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ubicaci√≥n de Firmas E-digital</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        /* CSS Responsive */
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; color: #333; display: flex; flex-direction: column; align-items: center; padding: 20px 10px; margin: 0; overflow-x: hidden; }
        .panel { background: #ffffff; padding: 30px 20px; border-radius: 12px; width: 100%; max-width: 800px; box-sizing: border-box; box-shadow: 0 4px 20px rgba(0,0,0,0.05); text-align: center; margin-bottom: 20px; border: 1px solid #e0e0e0; }
        h2 { margin-top: 0; color: #2c3e50; font-size: 24px; }
        p { color: #7f8c8d; font-size: 15px; margin-bottom: 20px; }
        .upload-area { border: 2px dashed #bdc3c7; border-radius: 8px; padding: 30px 10px; cursor: pointer; background: #fafafa; margin-bottom: 20px; display: block; transition: 0.3s; word-wrap: break-word; }
        .upload-area:hover, .upload-area.dragover { border-color: #3498db; background: #ebf5fb; }
        #pdfFile { display: none; }
        
        button { background: #3498db; color: #fff; border: none; padding: 12px 20px; font-size: 15px; font-weight: bold; border-radius: 6px; cursor: pointer; transition: 0.2s; width: 100%; max-width: 250px; margin: 5px; }
        button:hover { background: #2980b9; transform: scale(1.02); }
        .btn-add { background: #2ecc71; display: none; }
        .btn-add:hover { background: #27ae60; }
        .btn-save { background: #e67e22; display: none; }
        .btn-save:hover { background: #d35400; }
        
        .botones-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px; }
        
        /* Visor Responsive */
        #visor-container { display: none; margin-top: 20px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); background: white; max-width: 100%; overflow: hidden; }
        canvas { display: block; max-width: 100%; height: auto; }
        
        .firma-box { position: absolute; width: 160px; height: 56px; background: rgba(46, 204, 113, 0.2); border: 2px solid #2ecc71; color: #27ae60; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: grab; user-select: none; border-radius: 4px; touch-action: none; text-align: center; font-size: 13px; line-height: 1.1; padding: 2px; box-sizing: border-box; }
        .firma-box:active { cursor: grabbing; background: rgba(46, 204, 113, 0.4); }
        .firma-box span { font-size: 9px; font-weight: normal; color: #7f8c8d; pointer-events: none; margin-top: 2px;}

        /* Ajustes para celulares peque√±os */
        @media (max-width: 600px) {
            h2 { font-size: 20px; }
            button { max-width: 100%; }
        }
    </style>
</head>
<body>

    <div class="panel">
        <h2>Ubicaci√≥n de Firmas</h2>
        <p>Sube el documento, ubica las firmas y env√≠a la configuraci√≥n.</p>
        
        <label for="pdfFile" class="upload-area" id="drop-area">
            <span style="font-size: 30px;">üìÑ</span><br><br>
            <span id="file-label" style="font-weight: bold; color: #2c3e50;">Toca aqu√≠ o arrastra tu PDF</span>
        </label>
        <input type="file" id="pdfFile" accept="application/pdf">
        
        <div class="botones-container">
            <button id="btnProcesar" onclick="procesarPDF()">Procesar Documento</button>
            <button id="btnAgregarFirma" class="btn-add" onclick="agregarFirma()">+ A√±adir Firma</button>
            <button id="btnGuardar" class="btn-save" onclick="enviarAE_digital()">üíæ Guardar Configuraci√≥n</button>
        </div>
        <div id="loader" style="display:none; color: #3498db; margin-top: 15px; font-weight: bold;">Procesando documento... ‚è≥</div>
    </div>

    <div id="visor-container">
        <canvas id="pdf-canvas"></canvas>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let currentJson = { positions: {} };
        let pageHeight = 0;
        let currentScale = 1.0; // Se calcular√° din√°micamente
        const FIRMA_H = 50; // Altura est√°ndar de la firma
        let htmlDelJefe = ""; 

        const fileInput = document.getElementById('pdfFile');
        const fileLabel = document.getElementById('file-label');
        const dropArea = document.getElementById('drop-area');





        dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('dragover'); });
        dropArea.addEventListener('dragleave', () => dropArea.classList.remove('dragover'));
        dropArea.addEventListener('drop', (e) => { e.preventDefault(); dropArea.classList.remove('dragover'); if(e.dataTransfer.files.length) { fileInput.files = e.dataTransfer.files; actualizarNombre(); } });
        fileInput.addEventListener('change', actualizarNombre);

        function actualizarNombre() { 
            if(fileInput.files.length > 0) {
                // Acortar nombres largos en pantallas m√≥viles
                let name = fileInput.files[0].name;
                if(name.length > 25) name = name.substring(0, 22) + '...';
                fileLabel.textContent = "‚úÖ " + name; 
            }
        }

        async function procesarPDF() {
            const file = fileInput.files[0];
            if (!file) return alert("Selecciona un PDF primero.");

            document.getElementById('btnProcesar').style.display = 'none';
            document.getElementById('loader').style.display = 'block';
            document.getElementById('drop-area').style.display = 'none'; 

            const formData = new FormData();
            formData.append('documento', file);

            try {
                const res = await fetch('/api/procesar', { method: 'POST', body: formData });
                if (!res.ok) throw new Error("Error en el servidor Python.");
                const serverData = await res.json();
                
                htmlDelJefe = serverData.html_jefe;
                pageHeight = serverData.meta.page_height;
                currentJson.positions = {};
                
                await renderizarPDF(file, serverData.meta.paginas_totales);
                
                document.getElementById('visor-container').style.display = 'block';
                document.getElementById('btnAgregarFirma').style.display = 'inline-block'; 
                document.getElementById('btnGuardar').style.display = 'inline-block'; 

            } catch (err) {
                alert("‚ùå " + err.message);
                document.getElementById('drop-area').style.display = 'block';
                document.getElementById('btnProcesar').style.display = 'inline-block';
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function renderizarPDF(file, totalPaginas) {
            const fileURL = URL.createObjectURL(file);
            const pdf = await pdfjsLib.getDocument(fileURL).promise;
            const page = await pdf.getPage(totalPaginas);
            
            // --- C√ÅLCULO DE ESCALA RESPONSIVE ---
            const viewportSinEscala = page.getViewport({ scale: 1.0 });
            // Calculamos cu√°nto ancho tenemos disponible en la pantalla (dejando margen)
            const anchoDisponible = Math.min(window.innerWidth - 30, 800); 
            // La nueva escala es el ancho de pantalla dividido por el ancho real del PDF
            currentScale = anchoDisponible / viewportSinEscala.width;
            
            // Limitamos para que en monitores gigantes no se vea exageradamente grande
            if (currentScale > 1.5) currentScale = 1.5; 

            const viewport = page.getViewport({ scale: currentScale }); 
            const canvas = document.getElementById('pdf-canvas');
            const context = canvas.getContext('2d');
            canvas.width = viewport.width; 
            canvas.height = viewport.height;
            document.getElementById('visor-container').style.width = viewport.width + "px";
            
            await page.render({ canvasContext: context, viewport: viewport }).promise;
        }

        function agregarFirma() {
            // 1. Preguntamos el n√∫mero de orden indicando el l√≠mite
            let inputFirma = prompt("Ingresa el N√öMERO de orden de esta firma en el flujo legal:\n(Ej: 1 para el primero en firmar, 2 para el segundo)", "1");
            
            // Si el usuario presiona "Cancelar" en la ventanita, detenemos todo sin molestar
            if (inputFirma === null) return;
            
            // Quitamos espacios en blanco accidentales al principio o al final
            inputFirma = inputFirma.trim();

            // VALIDACI√ìN ESTRICTA 1: No vac√≠o, sin letras, sin s√≠mbolos
            // La expresi√≥n /^\d+$/ obliga a que el contenido sean √öNICAMENTE d√≠gitos
            if (inputFirma === "" || !/^\d+$/.test(inputFirma)) {
                return alert("‚ö†Ô∏è Error: Debes ingresar √∫nicamente un n√∫mero entero positivo (sin letras, signos o espacios).");
            }

            // Convertimos el texto verificado a un n√∫mero matem√°tico real
            let numeroFirma = parseInt(inputFirma, 10);

            // VALIDACI√ìN ESTRICTA 2: L√≠mites (Mayor a 0 y M√°ximo 15)
            if (numeroFirma < 1 || numeroFirma > 15) {
                return alert("‚ö†Ô∏è Error: El n√∫mero de firma debe estar entre 1 y 15.");
            }

            // CREAMOS EL ID PERFECTO PARA PHP (ej: "signer-1")
            let signerKey = 'signer-' + numeroFirma; 

            // Seguridad: Evitamos que agreguen dos veces al mismo firmante
            if (currentJson.positions[signerKey]) {
                return alert("‚ö†Ô∏è Ya agregaste las coordenadas para el firmante " + numeroFirma + ". Si quieres reubicarlo, arrastra la caja que ya existe o dale doble toque para borrarla.");
            }

            // 2. Preguntamos el nombre visual para la pantalla
            let nombreVisible = prompt("¬øQu√© nombre descriptivo tiene esta firma?\n(Ej: Representante Legal, Trabajador)", "Firmante " + numeroFirma);
            
            // Si cancela o lo deja en blanco, le ponemos un nombre por defecto seguro
            if (!nombreVisible || nombreVisible.trim() === "") {
                nombreVisible = "Firmante " + numeroFirma;
            }

            // 3. Posicionamos la nueva firma en el documento
            currentJson.positions[signerKey] = { x: 50, y: pageHeight - 150 };
            
            const box = document.createElement('div');
            box.id = 'box-' + signerKey; 
            box.className = 'firma-box';
            
            box.innerHTML = `${nombreVisible} <br><span style="color:#2196f3; font-weight:bold;">[${signerKey}]</span><br><span>(Doble toque borrar)</span>`;
            
            box.ondblclick = function() { box.remove(); delete currentJson.positions[signerKey]; };
            
            document.getElementById('visor-container').appendChild(box);
            colocarCaja(box.id, currentJson.positions[signerKey]);
        }

        function colocarCaja(id, pos) {
            const box = document.getElementById(id);
            // Aplicamos la escala matem√°tica a la posici√≥n visual
            box.style.left = (pos.x * currentScale) + 'px'; 
            box.style.top = ((pageHeight - pos.y - FIRMA_H) * currentScale) + 'px';
            hacerArrastrable(box, id.replace('box-', ''));
        }

        function hacerArrastrable(elmnt, signerKey) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

            // Soporte para MOUSE (PC)
            elmnt.onmousedown = dragMouseDown;
            // Soporte para T√ÅCTIL (Celulares y Tablets)
            elmnt.ontouchstart = dragTouchStart;

            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX; pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                elmnt.style.zIndex = 10;
            }

            function dragTouchStart(e) {
                pos3 = e.touches[0].clientX; pos4 = e.touches[0].clientY;
                document.ontouchend = closeDragElement;
                document.ontouchmove = touchDrag;
                elmnt.style.zIndex = 10;
            }

            function elementDrag(e) {
                e.preventDefault();
                moverCaja(e.clientX, e.clientY);
            }

            function touchDrag(e) {
                e.preventDefault(); // Evita que la pantalla haga "scroll" mientras arrastras la firma
                moverCaja(e.touches[0].clientX, e.touches[0].clientY);
            }

            function moverCaja(clientX, clientY) {
                pos1 = pos3 - clientX;
                pos2 = pos4 - clientY;
                pos3 = clientX;
                pos4 = clientY;
                
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";

                // Des-escalamos para guardar las coordenadas matem√°ticamente puras para PHP
                currentJson.positions[signerKey].x = Math.round(elmnt.offsetLeft / currentScale);
                currentJson.positions[signerKey].y = Math.round(pageHeight - (elmnt.offsetTop / currentScale) - FIRMA_H);
            }

            function closeDragElement() {
                document.onmouseup = null; document.onmousemove = null;
                document.ontouchend = null; document.ontouchmove = null;
                elmnt.style.zIndex = 1;
            }
        }

        function enviarAE_digital() {
            if (Object.keys(currentJson.positions).length === 0) {
                return alert("‚ö†Ô∏è Por favor, a√±ade al menos una firma.");
            }

            const paqueteFinal = {
                tipo: 'GUARDAR_PLANTILLA_COMPLETA',
                datos: {
                    html_documento: htmlDelJefe,
                    coordenadas_firmas: currentJson.positions,
                    total_firmas: Object.keys(currentJson.positions).length
                }
            };

            window.parent.postMessage(paqueteFinal, '*');
            console.log("PAQUETE ENVIADO:", paqueteFinal);

            // --- NUEVO: Feedback visual en el bot√≥n ---
            const btn = document.getElementById('btnGuardar');
            const textoOriginal = btn.innerHTML;
            
            // Cambiamos el texto y color temporalmente
            btn.innerHTML = "‚úÖ ¬°Actualizado y Guardado!";
            btn.style.background = "#27ae60"; // Verde √©xito
            
            // Volvemos a la normalidad despu√©s de 2 segundos
            setTimeout(() => {
                btn.innerHTML = textoOriginal;
                btn.style.background = ""; // Vuelve al color naranja original
            }, 2500);
        }
    </script>
</body>
</html>