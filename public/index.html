
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ubicaci√≥n de Firmas E-digital (V2.0 - Solo Eje Y Invertido)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; color: #333; display: flex; flex-direction: column; align-items: center; padding: 20px 10px; margin: 0; overflow-x: hidden; }
        .panel { background: #ffffff; padding: 30px 20px; border-radius: 12px; width: 100%; max-width: 800px; box-sizing: border-box; box-shadow: 0 4px 20px rgba(0,0,0,0.05); text-align: center; margin-bottom: 20px; border: 1px solid #e0e0e0; }
        h2 { margin-top: 0; color: #2c3e50; font-size: 24px; }
        p { color: #7f8c8d; font-size: 15px; margin-bottom: 20px; }
        .upload-area { border: 2px dashed #bdc3c7; border-radius: 8px; padding: 30px 10px; cursor: pointer; background: #fafafa; margin-bottom: 20px; display: block; transition: 0.3s; word-wrap: break-word; }
        .upload-area:hover, .upload-area.dragover { border-color: #3498db; background: #ebf5fb; }
        #pdfFile { display: none; }
        
        button { background: #3498db; color: #fff; border: none; padding: 12px 20px; font-size: 15px; font-weight: bold; border-radius: 6px; cursor: pointer; transition: 0.2s; margin: 5px; }
        button:hover { background: #2980b9; transform: scale(1.02); }
        button:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; }
        
        .btn-add-auto { background: #2ecc71; display: none; }
        .btn-add-auto:hover { background: #27ae60; }
        .btn-save { background: #e67e22; display: none; }
        .btn-save:hover { background: #d35400; }
        
        .botones-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px; }
        
        #paginacion-container { display: none; align-items: center; justify-content: center; gap: 15px; margin-top: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .btn-pagina { padding: 8px 15px; background: #34495e; font-size: 14px; width: auto; }
        .btn-pagina:hover { background: #2c3e50; }
        .texto-pagina { font-weight: bold; color: #2c3e50; font-size: 16px; display: flex; align-items: center; gap: 5px; }
        
        #input-pagina { width: 50px; text-align: center; font-size: 16px; font-weight: bold; color: #2c3e50; border: 2px solid #bdc3c7; border-radius: 6px; padding: 4px; outline: none; transition: 0.2s; }
        #input-pagina:focus { border-color: #3498db; background: #ebf5fb; }
        #input-pagina::-webkit-outer-spin-button, #input-pagina::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #input-pagina[type=number] { -moz-appearance: textfield; }

        #visor-container { display: none; margin-top: 20px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); background: white; max-width: 100%; overflow: hidden; }
        canvas { display: block; max-width: 100%; height: auto; }
        
        .firma-box { position: absolute; width: 160px; height: 56px; background: rgba(46, 204, 113, 0.2); border: 2px solid #2ecc71; color: #27ae60; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: grab; user-select: none; border-radius: 4px; touch-action: none; text-align: center; line-height: 1.1; padding: 2px 4px; box-sizing: border-box; overflow: visible; }
        .firma-box:active { cursor: grabbing; background: rgba(46, 204, 113, 0.4); }
        
        .btn-cerrar-firma { position: absolute; top: -8px; right: -8px; background: #e74c3c; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; z-index: 20; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: 0.2s; }
        .btn-cerrar-firma:hover { background: #c0392b; transform: scale(1.15); }
        
        .nombre-firma { font-size: 11px; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; pointer-events: none; }
        .id-firma { font-size: 9px; color: #2196f3; font-weight: bold; pointer-events: none; margin-top: 1px; }

        .guia-magnetica { position: absolute; background-color: #e74c3c; display: none; pointer-events: none; z-index: 5; opacity: 0.8; }
        #guia-v { width: 1.5px; height: 100%; top: 0; }
        #guia-h { height: 1.5px; width: 100%; left: 0; }

        @media (max-width: 600px) {
            h2 { font-size: 20px; }
            button { width: 100%; }
            #paginacion-container { flex-direction: column; }
            .btn-pagina { width: 100%; }
        }
    </style>
</head>
<body>

    <div class="panel">
        <h2>Ubicaci√≥n de Firmas</h2>
        <p>Sube el documento, navega por las p√°ginas y ubica las firmas.</p>
        
        <label for="pdfFile" class="upload-area" id="drop-area">
            <span style="font-size: 30px;">üìÑ</span><br><br>
            <span id="file-label" style="font-weight: bold; color: #2c3e50; transition: 0.3s;">Toca aqu√≠ o arrastra tu PDF</span>
        </label>
        <input type="file" id="pdfFile" accept="application/pdf">
        
        <div class="botones-container">
            <button id="btnProcesar" onclick="procesarPDF()">1. Procesar Documento</button>
            <button id="btnGenerar" class="btn-add-auto" onclick="agregarSiguienteFirma()">2. A√±adir Firma</button>
            <button id="btnGuardar" class="btn-save" onclick="enviarAE_digital()">3. üíæ Guardar Configuraci√≥n</button>
        </div>
        
        <div id="paginacion-container">
            <button class="btn-pagina" id="btnAnterior" onclick="cambiarPagina(-1)">‚óÄ Anterior</button>
            <span class="texto-pagina">
                P√°gina 
                <input type="number" id="input-pagina" value="1" min="1" onchange="irAPaginaEspecifica()" onkeydown="if(event.key === 'Enter') irAPaginaEspecifica()"> 
                de <span id="total-paginas">1</span>
            </span>
            <button class="btn-pagina" id="btnSiguiente" onclick="cambiarPagina(1)">Siguiente ‚ñ∂</button>
        </div>

        <div id="loader" style="display:none; color: #3498db; margin-top: 15px; font-weight: bold;">Cargando documento... ‚è≥</div>
    </div>

    <div id="visor-container">
        <canvas id="pdf-canvas"></canvas>
        <div id="guia-v" class="guia-magnetica"></div>
        <div id="guia-h" class="guia-magnetica"></div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfGlobal = null;
        let paginaActualNum = 1;
        let totalPaginasGlobal = 1;
        
        // --- CAMBIO 1: Solo necesitamos la altura para invertir Y ---
        let pageHeight = 0;
        
        let currentScale = 1.0; 
        const FIRMA_H = 56; 
        const UMBRAL_MAGNETICO = 12; 

        let currentJson = { positions: {} };
        let htmlDelJefe = ""; 
        let cantidadFirmantes = 0; 

        const fileInput = document.getElementById('pdfFile');
        const fileLabel = document.getElementById('file-label');
        const dropArea = document.getElementById('drop-area');

        window.addEventListener('message', function(event) {
            if (event.data && event.data.tipo === 'CONFIGURAR_FIRMAS') {
                let cantidadRecibida = parseInt(event.data.cantidad) || 0;
                
                if (cantidadRecibida <= 0) {
                    alert("‚ö†Ô∏è Error: El documento debe tener al menos 1 firma asignada.");
                    cantidadFirmantes = 0;
                    document.getElementById('btnGenerar').style.display = 'none';
                    return; 
                }

                if (cantidadRecibida > 15) {
                    alert("‚ö†Ô∏è Se limit√≥ a 15 firmas m√°ximas permitidas.");
                    cantidadFirmantes = 15;
                } else {
                    cantidadFirmantes = cantidadRecibida;
                }
                
                if (pdfGlobal !== null && cantidadFirmantes > 0) {
                    actualizarBotonGenerar();
                }
            }
        });

        function validarArchivo(file) {
            if (file.type !== "application/pdf" && !file.name.toLowerCase().endsWith('.pdf')) {
                alert("‚ùå Archivo inv√°lido. Por favor, arrastra √öNICAMENTE un documento en formato PDF.");
                
                fileInput.value = ""; 
                fileLabel.textContent = "‚ö†Ô∏è Error: Solo se aceptan archivos PDF";
                fileLabel.style.color = "#e74c3c"; 
                dropArea.style.borderColor = "#e74c3c"; 
                
                setTimeout(() => {
                    fileLabel.textContent = "Toca aqu√≠ o arrastra tu PDF";
                    fileLabel.style.color = "#2c3e50";
                    dropArea.style.borderColor = "#bdc3c7";
                }, 3500);
                
                return false;
            }

            let name = file.name;
            if(name.length > 25) name = name.substring(0, 22) + '...';
            fileLabel.textContent = "‚úÖ " + name;
            fileLabel.style.color = "#27ae60";
            dropArea.style.borderColor = "#2ecc71";
            return true;
        }

        dropArea.addEventListener('dragover', (e) => { 
            e.preventDefault(); 
            dropArea.classList.add('dragover'); 
        });
        
        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('dragover'); 
        });
        
        dropArea.addEventListener('drop', (e) => { 
            e.preventDefault(); 
            dropArea.classList.remove('dragover'); 
            if(e.dataTransfer.files.length) { 
                const file = e.dataTransfer.files[0];
                if (validarArchivo(file)) {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files; 
                }
            } 
        });

        fileInput.addEventListener('change', () => { 
            if(fileInput.files.length > 0) validarArchivo(fileInput.files[0]); 
        });

        async function procesarPDF() {
            const file = fileInput.files[0];
            if (!file) return alert("Selecciona un PDF primero.");

            document.getElementById('btnProcesar').style.display = 'none';
            document.getElementById('loader').style.display = 'block';
            document.getElementById('drop-area').style.display = 'none'; 

            try {
                const fileURL = URL.createObjectURL(file);
                pdfGlobal = await pdfjsLib.getDocument(fileURL).promise;
                totalPaginasGlobal = pdfGlobal.numPages;
                paginaActualNum = 1; 
                
                document.getElementById('total-paginas').innerText = totalPaginasGlobal;
                document.getElementById('input-pagina').max = totalPaginasGlobal; 
                
                document.querySelectorAll('.firma-box').forEach(box => box.remove());
                currentJson.positions = {};
                htmlDelJefe = "<div>Contenido procesado localmente.</div>"; 
                
                await renderizarPaginaActual();
                
                document.getElementById('visor-container').style.display = 'block';
                document.getElementById('paginacion-container').style.display = 'flex';
                document.getElementById('btnGuardar').style.display = 'inline-block'; 
                actualizarBotonesPaginacion();

                if (cantidadFirmantes > 0) {
                    actualizarBotonGenerar();
                }

            } catch (err) {
                alert("‚ùå Error: " + err.message);
                document.getElementById('drop-area').style.display = 'block';
                document.getElementById('btnProcesar').style.display = 'inline-block';
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function cambiarPagina(delta) {
            let nuevaPagina = paginaActualNum + delta;
            if (nuevaPagina >= 1 && nuevaPagina <= totalPaginasGlobal) {
                paginaActualNum = nuevaPagina;
                await renderizarPaginaActual();
                actualizarBotonesPaginacion();
                actualizarVisibilidadFirmas(); 
            }
        }

        async function irAPaginaEspecifica() {
            let input = document.getElementById('input-pagina');
            let nuevaPagina = parseInt(input.value);
            
            if (isNaN(nuevaPagina) || nuevaPagina < 1) {
                nuevaPagina = 1;
            } else if (nuevaPagina > totalPaginasGlobal) {
                nuevaPagina = totalPaginasGlobal;
            }
            
            if (nuevaPagina !== paginaActualNum) {
                paginaActualNum = nuevaPagina;
                await renderizarPaginaActual();
                actualizarBotonesPaginacion();
                actualizarVisibilidadFirmas();
            } else {
                input.value = paginaActualNum;
            }
            
            input.blur(); 
        }

        function actualizarBotonesPaginacion() {
            document.getElementById('input-pagina').value = paginaActualNum; 
            document.getElementById('btnAnterior').disabled = (paginaActualNum <= 1);
            document.getElementById('btnSiguiente').disabled = (paginaActualNum >= totalPaginasGlobal);
        }

        async function renderizarPaginaActual() {
            const page = await pdfGlobal.getPage(paginaActualNum);
            const viewportSinEscala = page.getViewport({ scale: 1.0 });
            
            // --- CAMBIO 2: Registramos solo la altura original ---
            pageHeight = viewportSinEscala.height; 

            const anchoDisponible = Math.min(window.innerWidth - 30, 800); 
            currentScale = anchoDisponible / viewportSinEscala.width;
            if (currentScale > 1.5) currentScale = 1.5; 

            const viewport = page.getViewport({ scale: currentScale }); 
            const canvas = document.getElementById('pdf-canvas');
            const context = canvas.getContext('2d');
            canvas.width = viewport.width; 
            canvas.height = viewport.height;
            document.getElementById('visor-container').style.width = viewport.width + "px";
            
            await page.render({ canvasContext: context, viewport: viewport }).promise;
            reposicionarFirmasPorEscala();
        }

        function actualizarVisibilidadFirmas() {
            document.querySelectorAll('.firma-box').forEach(box => {
                let key = box.id.replace('box-', '');
                if (currentJson.positions[key] && currentJson.positions[key].pagina === paginaActualNum) {
                    box.style.display = 'flex';
                } else {
                    box.style.display = 'none';
                }
            });
        }

        function reposicionarFirmasPorEscala() {
            document.querySelectorAll('.firma-box').forEach(box => {
                let key = box.id.replace('box-', '');
                if (currentJson.positions[key] && currentJson.positions[key].pagina === paginaActualNum) {
                    colocarCaja(box.id, currentJson.positions[key]);
                }
            });
        }

        function obtenerSiguienteNumeroDisponible() {
            for (let i = 1; i <= cantidadFirmantes; i++) {
                if (!currentJson.positions['signer-' + i]) {
                    return i;
                }
            }
            return null;
        }

        function actualizarBotonGenerar() {
            let generadas = Object.keys(currentJson.positions).length;
            const btnGen = document.getElementById('btnGenerar');
            
            btnGen.style.display = 'inline-block';
            
            if (generadas >= cantidadFirmantes) {
                btnGen.innerHTML = "‚úÖ Firmas Generadas";
                btnGen.style.background = "#95a5a6"; 
            } else {
                btnGen.innerHTML = `2. A√±adir Firma (${generadas}/${cantidadFirmantes})`;
                btnGen.style.background = "#2ecc71";
            }
        }

        function agregarSiguienteFirma() {
            let numeroFirma = obtenerSiguienteNumeroDisponible();
            if (!numeroFirma) return; 

            let signerKey = 'signer-' + numeroFirma;
            
            let cantidadActual = Object.keys(currentJson.positions).length;
            let posicionYInicial = Math.round(pageHeight - 100 - (cantidadActual * 65));
            if (posicionYInicial < 0) posicionYInicial = 10; 
            
            currentJson.positions[signerKey] = { 
                x: 50, 
                y: posicionYInicial, 
                pagina: paginaActualNum 
            };
            
            const box = document.createElement('div');
            box.id = 'box-' + signerKey; 
            box.className = 'firma-box';
            
            box.innerHTML = `
                <div class="btn-cerrar-firma" onclick="eliminarFirma(event, '${signerKey}')">√ó</div>
                <div class="nombre-firma">Firmante ${numeroFirma}</div> 
                <div class="id-firma">[${signerKey}]</div>
            `;
            
            document.getElementById('visor-container').appendChild(box);
            colocarCaja(box.id, currentJson.positions[signerKey]);
            actualizarBotonGenerar();
        }

        window.eliminarFirma = function(event, signerKey) {
            event.stopPropagation(); 
            
            let box = document.getElementById('box-' + signerKey);
            if(box) box.remove();
            
            delete currentJson.positions[signerKey];
            actualizarBotonGenerar();
        };

        function colocarCaja(id, pos) {
            const box = document.getElementById(id);
            if(!box) return;
            box.style.left = (pos.x * currentScale) + 'px'; 
            box.style.top = ((pageHeight - pos.y - FIRMA_H) * currentScale) + 'px';
            hacerArrastrable(box, id.replace('box-', ''));
        }

        function hacerArrastrable(elmnt, signerKey) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            let logicaLeft = 0, logicaTop = 0; 
            
            const guiaV = document.getElementById('guia-v');
            const guiaH = document.getElementById('guia-h');

            elmnt.onmousedown = dragMouseDown;
            elmnt.ontouchstart = dragTouchStart;

            function dragMouseDown(e) {
                if(e.target.className === 'btn-cerrar-firma') return; 
                e.preventDefault();
                pos3 = e.clientX; pos4 = e.clientY;
                logicaLeft = elmnt.offsetLeft; 
                logicaTop = elmnt.offsetTop;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                elmnt.style.zIndex = 10;
            }

            function dragTouchStart(e) {
                if(e.target.className === 'btn-cerrar-firma') return;
                pos3 = e.touches[0].clientX; pos4 = e.touches[0].clientY;
                logicaLeft = elmnt.offsetLeft; 
                logicaTop = elmnt.offsetTop;
                document.ontouchend = closeDragElement;
                document.ontouchmove = touchDrag;
                elmnt.style.zIndex = 10;
            }

            function elementDrag(e) { e.preventDefault(); moverCaja(e.clientX, e.clientY); }
            function touchDrag(e) { e.preventDefault(); moverCaja(e.touches[0].clientX, e.touches[0].clientY); }

            function moverCaja(clientX, clientY) {
                pos1 = pos3 - clientX;
                pos2 = pos4 - clientY;
                pos3 = clientX;
                pos4 = clientY;

                logicaTop = logicaTop - pos2;
                logicaLeft = logicaLeft - pos1;

                const container = document.getElementById('pdf-canvas');
                const maxTop = container.height - FIRMA_H;
                const maxLeft = container.width - 160; 

                if (logicaTop < 0) logicaTop = 0;
                if (logicaTop > maxTop) logicaTop = maxTop;
                if (logicaLeft < 0) logicaLeft = 0;
                if (logicaLeft > maxLeft) logicaLeft = maxLeft;

                let visualTop = logicaTop;
                let visualLeft = logicaLeft;
                let snapV = false, snapH = false;
                
                document.querySelectorAll('.firma-box').forEach(otraCaja => {
                    if (otraCaja.id !== elmnt.id && otraCaja.style.display !== 'none') {
                        let otraTop = otraCaja.offsetTop;
                        let otraLeft = otraCaja.offsetLeft;

                        if (Math.abs(logicaLeft - otraLeft) < UMBRAL_MAGNETICO) {
                            visualLeft = otraLeft; 
                            snapV = true;
                            guiaV.style.left = visualLeft + "px";
                            guiaV.style.display = "block";
                        }
                        if (Math.abs(logicaTop - otraTop) < UMBRAL_MAGNETICO) {
                            visualTop = otraTop; 
                            snapH = true;
                            guiaH.style.top = visualTop + "px";
                            guiaH.style.display = "block";
                        }
                    }
                });

                if (!snapV) guiaV.style.display = "none";
                if (!snapH) guiaH.style.display = "none";

                elmnt.style.top = visualTop + "px";
                elmnt.style.left = visualLeft + "px";

                let xFinal = Math.round(visualLeft / currentScale);
                let yFinal = Math.round(pageHeight - ((visualTop + FIRMA_H) / currentScale));

                if (currentJson.positions[signerKey]) {
                    currentJson.positions[signerKey].x = Math.max(0, xFinal);
                    currentJson.positions[signerKey].y = Math.max(0, yFinal);
                    currentJson.positions[signerKey].pagina = paginaActualNum; 
                }
            }

            function closeDragElement() {
                document.onmouseup = null; document.onmousemove = null;
                document.ontouchend = null; document.ontouchmove = null;
                elmnt.style.zIndex = 1;
                guiaV.style.display = "none";
                guiaH.style.display = "none";
            }
        }

        function enviarAE_digital() {
            let generadas = Object.keys(currentJson.positions).length;
            if (generadas < cantidadFirmantes) {
                return alert(`‚ö†Ô∏è Te falta ubicar firmas. Llevas ${generadas} de ${cantidadFirmantes}.`);
            }

            // --- CAMBIO 3: Invertimos SOLO el eje Y antes de enviarlo ya que FirmaAki lo lee de esa manera---
            let coordenadasInvertidas = {};
            
            for (let key in currentJson.positions) {
                let original = currentJson.positions[key];
                
                coordenadasInvertidas[key] = {
                    x: original.x, // El eje X viaja normal
                    y: Math.round(pageHeight - original.y - (FIRMA_H / currentScale)), // Eje Y invertido (Alto - Y)
                    pagina: original.pagina
                };
            }

            const paqueteFinal = {
                tipo: 'GUARDAR_PLANTILLA_COMPLETA',
                datos: {
                    html_documento: htmlDelJefe,
                    coordenadas_firmas: coordenadasInvertidas, // Enviamos el JSON ajustado
                    total_firmas: generadas
                }
            };

            window.parent.postMessage(paqueteFinal, '*');
            console.log("PAQUETE ENVIADO AL BACKEND (Y INVERTIDA):", paqueteFinal);

            const btn = document.getElementById('btnGuardar');
            btn.innerHTML = "‚úÖ Configuraci√≥n Enviada";
            btn.style.background = "#27ae60"; 
            setTimeout(() => { btn.innerHTML = "3. üíæ Guardar Configuraci√≥n"; btn.style.background = ""; }, 2500);
        }
    </script>
</body>
</html>